<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Admin Dashboard ‚Ä¢ Healthy Diet</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    .admin-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
      font-size: 13px;
    }
    .admin-table th {
      background: var(--ring);
      padding: 10px 8px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid var(--accent);
    }
    .admin-table td {
      padding: 10px 8px;
      border-bottom: 1px solid var(--ring);
    }
    .admin-table tr:hover {
      background: rgba(79, 195, 255, 0.05);
    }
    @media (max-width: 768px) {
      .admin-table {
        font-size: 11px;
      }
      .admin-table th,
      .admin-table td {
        padding: 8px 4px;
      }
    }
  </style>
</head>
<body class="bg">

  <div style="max-width: 1200px; margin: 0 auto; padding: 12px;">
    
    <!-- Login Screen -->
    <div id="loginScreen">
      <div class="panel" style="max-width: 400px; margin: 40px auto;">
        <h2 style="margin-top: 0;">üîê Admin Login</h2>
        <p style="color: var(--muted); font-size: 14px; margin-bottom: 20px;">
          Enter admin credentials to access the dashboard.
        </p>
        
        <form id="loginForm">
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 6px; font-weight: 500;">Admin Key</label>
            <input type="password" id="adminKey" placeholder="Enter admin key" style="
              width: 100%;
              padding: 10px 12px;
              border: 1px solid var(--ring);
              background: var(--bg);
              color: var(--text);
              border-radius: 8px;
              font-size: 14px;
            " required/>
            <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">
              Demo key: demo_admin_key_123
            </div>
          </div>
          
          <button type="submit" class="pill w100">Login</button>
          
          <div id="loginError" style="display: none; margin-top: 12px; padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; color: #ef4444; font-size: 13px; text-align: center;">
          </div>
        </form>
      </div>
    </div>

    <!-- Dashboard Screen -->
    <div id="dashboardScreen" style="display: none;">
      <header class="topbar">
        <div class="topbar-left">
          <span class="avatar">üë®‚Äçüíº</span>
          <span class="uname">Admin Dashboard</span>
        </div>
        <div>
          <button class="icon-btn" id="refreshBtn" title="Refresh">üîÑ</button>
          <button class="linklike" id="logoutBtn">Logout</button>
        </div>
      </header>

      <main style="margin-top: 16px;">
        <section class="panel">
          <div class="row-between">
            <h3>All Orders</h3>
            <div id="orderCount" style="color: var(--muted); font-size: 14px;">0 orders</div>
          </div>
          
          <!-- Filters -->
          <div style="margin: 16px 0; padding: 12px; background: rgba(79, 195, 255, 0.05); border-radius: 8px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
              <div>
                <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500;">Filter by Status</label>
                <select id="statusFilter" style="
                  width: 100%;
                  padding: 6px 10px;
                  border: 1px solid var(--ring);
                  background: var(--bg);
                  color: var(--text);
                  border-radius: 6px;
                  font-size: 13px;
                ">
                  <option value="">All Statuses</option>
                  <option value="placed">Placed</option>
                  <option value="accepted">Accepted</option>
                  <option value="preparing">Preparing</option>
                  <option value="ready_for_pickup">Ready for Pickup</option>
                  <option value="reached_vendor">Reached Vendor</option>
                  <option value="out_for_delivery">Out for Delivery</option>
                  <option value="near_destination">Near Destination</option>
                  <option value="delivered">Delivered</option>
                  <option value="cancelled">Cancelled</option>
                </select>
              </div>
              
              <div>
                <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500;">Assign Rider</label>
                <select id="riderSelect" style="
                  width: 100%;
                  padding: 6px 10px;
                  border: 1px solid var(--ring);
                  background: var(--bg);
                  color: var(--text);
                  border-radius: 6px;
                  font-size: 13px;
                " disabled>
                  <option value="">Select order first</option>
                </select>
              </div>
            </div>
          </div>
          
          <div id="ordersLoading" style="text-align: center; padding: 20px; color: var(--muted);">
            ‚è≥ Loading orders...
          </div>
          
          <div id="ordersError" style="display: none; text-align: center; padding: 20px; color: #ef4444;">
            ‚ö†Ô∏è Unable to load orders. 
            <button class="linklike" id="retryBtn">Try again</button>
          </div>
          
          <div id="ordersEmpty" style="display: none; text-align: center; padding: 20px; color: var(--muted);">
            <div style="font-size: 48px; margin-bottom: 12px;">üìã</div>
            <div>No orders found</div>
          </div>
          
          <div id="ordersTable" style="display: none; overflow-x: auto;"></div>
        </section>
      </main>
    </div>

  </div>

  <script>
    (function() {
      
      // State
      let adminKey = null;
      let allOrders = [];
      let selectedOrderId = null;
      
      // Rider configuration
      const RIDERS = [
        { id: 'rider01', name: 'Raj Kumar' },
        { id: 'rider02', name: 'Anita' },
        { id: 'rider03', name: 'Suresh' }
      ];
      
      // DOM elements
      const loginScreen = document.getElementById('loginScreen');
      const dashboardScreen = document.getElementById('dashboardScreen');
      const loginForm = document.getElementById('loginForm');
      const loginError = document.getElementById('loginError');
      const logoutBtn = document.getElementById('logoutBtn');
      const refreshBtn = document.getElementById('refreshBtn');
      const retryBtn = document.getElementById('retryBtn');
      const statusFilter = document.getElementById('statusFilter');
      const riderSelect = document.getElementById('riderSelect');
      const ordersLoading = document.getElementById('ordersLoading');
      const ordersError = document.getElementById('ordersError');
      const ordersEmpty = document.getElementById('ordersEmpty');
      const ordersTable = document.getElementById('ordersTable');
      const orderCount = document.getElementById('orderCount');
      
      // Login handler
      loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const key = document.getElementById('adminKey').value;
        
        // In production, this would verify against backend
        // For prototype, we accept the demo key
        if (key !== 'demo_admin_key_123') {
          showLoginError('Invalid admin key');
          return;
        }
        
        adminKey = key;
        sessionStorage.setItem('admin_key', adminKey);
        showDashboard();
      });
      
      function showLoginError(message) {
        loginError.textContent = message;
        loginError.style.display = 'block';
        setTimeout(() => {
          loginError.style.display = 'none';
        }, 3000);
      }
      
      function showDashboard() {
        loginScreen.style.display = 'none';
        dashboardScreen.style.display = 'block';
        loadOrders();
      }
      
      // Logout
      logoutBtn.addEventListener('click', () => {
        sessionStorage.removeItem('admin_key');
        adminKey = null;
        allOrders = [];
        loginScreen.style.display = 'block';
        dashboardScreen.style.display = 'none';
        loginForm.reset();
      });
      
      // Refresh
      refreshBtn.addEventListener('click', loadOrders);
      retryBtn.addEventListener('click', loadOrders);
      
      // Status filter
      statusFilter.addEventListener('change', renderOrders);
      
      // Populate rider dropdown
      riderSelect.innerHTML = '<option value="">Select rider</option>' + 
        RIDERS.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
      
      // Rider assignment
      riderSelect.addEventListener('change', async () => {
        const riderId = riderSelect.value;
        if (!riderId || !selectedOrderId) return;
        
        await updateOrderStatus(selectedOrderId, null, riderId);
        riderSelect.value = '';
        selectedOrderId = null;
        riderSelect.disabled = true;
      });
      
      // Format status badge
      function getStatusBadge(status) {
        const statusConfig = {
          'placed': { label: 'Placed', color: '#3b82f6' },
          'accepted': { label: 'Accepted', color: '#10b981' },
          'preparing': { label: 'Preparing', color: '#f59e0b' },
          'ready_for_pickup': { label: 'Ready', color: '#8b5cf6' },
          'reached_vendor': { label: 'At Vendor', color: '#ec4899' },
          'out_for_delivery': { label: 'Out', color: '#06b6d4' },
          'near_destination': { label: 'Near', color: '#14b8a6' },
          'delivered': { label: 'Delivered', color: '#10b981' },
          'cancelled': { label: 'Cancelled', color: '#ef4444' }
        };
        
        const config = statusConfig[status] || { label: status, color: '#6b7280' };
        return `<span style="
          display: inline-block;
          background: ${config.color};
          color: white;
          padding: 3px 8px;
          border-radius: 4px;
          font-size: 11px;
          font-weight: 600;
        ">${config.label}</span>`;
      }
      
      // Format time
      function formatTime(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleString('en-IN', { 
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      }
      
      // Escape HTML
      function escapeHtml(s) {
        return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      }
      
      // Get rider name
      function getRiderName(assignedRiderId) {
        if (!assignedRiderId) return '‚Äî';
        const rider = RIDERS.find(r => r.id === assignedRiderId);
        return rider ? rider.name : assignedRiderId;
      }
      
      // Update order status
      async function updateOrderStatus(orderId, newStatus = null, riderId = null) {
        try {
          const body = { order_id: orderId };
          if (newStatus) body.status = newStatus;
          if (riderId !== null) body.rider_id = riderId;
          
          const response = await fetch('/api/orders/status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });
          
          const data = await response.json();
          
          if (!response.ok || !data.success) {
            const errorMsg = data.error || 'Failed to update';
            throw new Error(errorMsg);
          }
          
          loadOrders();
          
        } catch (error) {
          console.error('Failed to update order:', error);
          alert(`Failed to update order: ${error.message}`);
        }
      }
      
      // Render orders
      function renderOrders() {
        ordersLoading.style.display = 'none';
        ordersError.style.display = 'none';
        ordersEmpty.style.display = 'none';
        ordersTable.style.display = 'none';
        
        // Apply filters
        const filterStatus = statusFilter.value;
        let filtered = allOrders;
        
        if (filterStatus) {
          filtered = filtered.filter(o => o.status === filterStatus);
        }
        
        if (!filtered || filtered.length === 0) {
          ordersEmpty.style.display = 'block';
          orderCount.textContent = '0 orders';
          return;
        }
        
        // Sort by created time (newest first)
        filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        
        // Update count
        orderCount.textContent = `${filtered.length} order${filtered.length !== 1 ? 's' : ''}`;
        
        // Render table
        const tableHtml = `
          <table class="admin-table">
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Dish</th>
                <th>Vendor</th>
                <th>Customer</th>
                <th>Status</th>
                <th>Rider</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${filtered.map(order => {
                const total = (order.price || 0) * (order.quantity || 1);
                return `
                  <tr>
                    <td style="font-family: monospace; font-size: 11px;">${order.order_id.substring(0, 12)}...</td>
                    <td>
                      <div style="font-weight: 600;">${escapeHtml(order.dish_title)}</div>
                      <div style="color: var(--muted); font-size: 11px;">Qty: ${order.quantity} ‚Ä¢ ‚Çπ${total}</div>
                    </td>
                    <td>${escapeHtml(order.vendor_name)}</td>
                    <td>
                      <div>${escapeHtml(order.phone)}</div>
                      <div style="color: var(--muted); font-size: 11px;">${escapeHtml(order.address.substring(0, 30))}...</div>
                    </td>
                    <td>${getStatusBadge(order.status)}</td>
                    <td>${getRiderName(order.assigned_rider_id)}</td>
                    <td style="white-space: nowrap;">${formatTime(order.created_at)}</td>
                    <td>
                      <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                        <select onchange="updateStatus('${order.order_id}', this.value); this.value='';" style="
                          padding: 4px 6px;
                          border: 1px solid var(--ring);
                          background: var(--bg);
                          color: var(--text);
                          border-radius: 4px;
                          font-size: 11px;
                        ">
                          <option value="">Change status</option>
                          <option value="placed">Placed</option>
                          <option value="accepted">Accepted</option>
                          <option value="preparing">Preparing</option>
                          <option value="ready_for_pickup">Ready</option>
                          <option value="reached_vendor">At Vendor</option>
                          <option value="out_for_delivery">Out</option>
                          <option value="near_destination">Near</option>
                          <option value="delivered">Delivered</option>
                          <option value="cancelled">Cancelled</option>
                        </select>
                        <button onclick="assignRider('${order.order_id}')" class="chip" style="font-size: 11px; padding: 4px 8px;">
                          üèçÔ∏è Assign
                        </button>
                      </div>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        `;
        
        ordersTable.innerHTML = tableHtml;
        ordersTable.style.display = 'block';
      }
      
      // Load orders
      async function loadOrders() {
        if (!adminKey) return;
        
        ordersLoading.style.display = 'block';
        ordersError.style.display = 'none';
        
        try {
          const response = await fetch(`/api/orders?admin_key=${encodeURIComponent(adminKey)}`);
          
          if (!response.ok) {
            throw new Error('Failed to load orders');
          }
          
          const data = await response.json();
          allOrders = data.orders || [];
          renderOrders();
          
        } catch (error) {
          console.error('Failed to load orders:', error);
          ordersLoading.style.display = 'none';
          ordersError.style.display = 'block';
        }
      }
      
      // Make functions global for onclick handlers
      window.updateStatus = (orderId, status) => {
        if (status) updateOrderStatus(orderId, status);
      };
      
      window.assignRider = (orderId) => {
        selectedOrderId = orderId;
        riderSelect.disabled = false;
        riderSelect.focus();
      };
      
      // Check if already logged in
      const savedKey = sessionStorage.getItem('admin_key');
      if (savedKey) {
        adminKey = savedKey;
        showDashboard();
      }
      
      // Auto-refresh every 10 seconds
      setInterval(() => {
        if (adminKey) {
          loadOrders();
        }
      }, 10000);
      
    })();
  </script>

  <script src="/netlify/widgets/admin_metrics_widget.js"></script>
</body>
</html>
